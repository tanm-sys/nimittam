# Nimittam Gallery - Chaos Engineering Tests
# Validates app resilience under adverse conditions

name: Chaos Engineering Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'Android/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'Android/**'
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of chaos tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - network
          - memory
          - battery
          - thermal
          - combined

env:
  # Test thresholds
  MAX_ACCEPTABLE_FAILURE_RATE: 10  # 10%
  MIN_RECOVERY_TIME_MS: 5000       # 5 seconds max recovery

jobs:
  # =============================================================================
  # Job 1: Network Chaos Tests
  # =============================================================================
  network-chaos:
    name: Network Resilience Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'network' || github.event_name != 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./Android/src
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Network Chaos Tests
        run: |
          ./gradlew testDebugUnitTest \
            --tests "*ChaosTestSuite*network*" \
            --continue || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: network-chaos-results
          path: |
            Android/src/app/build/test-results/
            Android/src/app/build/reports/tests/
          retention-days: 7

  # =============================================================================
  # Job 2: Memory Chaos Tests
  # =============================================================================
  memory-chaos:
    name: Memory Resilience Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'memory' || github.event_name != 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./Android/src
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Memory Chaos Tests
        run: |
          ./gradlew testDebugUnitTest \
            --tests "*ChaosTestSuite*memory*" \
            --continue || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: memory-chaos-results
          path: |
            Android/src/app/build/test-results/
            Android/src/app/build/reports/tests/
          retention-days: 7

  # =============================================================================
  # Job 3: Battery Chaos Tests
  # =============================================================================
  battery-chaos:
    name: Battery Resilience Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'battery' || github.event_name != 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./Android/src
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Battery Chaos Tests
        run: |
          ./gradlew testDebugUnitTest \
            --tests "*ChaosTestSuite*battery*" \
            --continue || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: battery-chaos-results
          path: |
            Android/src/app/build/test-results/
            Android/src/app/build/reports/tests/
          retention-days: 7

  # =============================================================================
  # Job 4: Thermal Chaos Tests
  # =============================================================================
  thermal-chaos:
    name: Thermal Resilience Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'thermal' || github.event_name != 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./Android/src
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Thermal Chaos Tests
        run: |
          ./gradlew testDebugUnitTest \
            --tests "*ChaosTestSuite*thermal*" \
            --continue || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: thermal-chaos-results
          path: |
            Android/src/app/build/test-results/
            Android/src/app/build/reports/tests/
          retention-days: 7

  # =============================================================================
  # Job 5: Combined Chaos Tests
  # =============================================================================
  combined-chaos:
    name: Combined Stress Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'combined' || github.event_name != 'workflow_dispatch'
    needs: [network-chaos, memory-chaos, battery-chaos, thermal-chaos]
    defaults:
      run:
        working-directory: ./Android/src
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Combined Chaos Tests
        run: |
          ./gradlew testDebugUnitTest \
            --tests "*ChaosTestSuite*combined*" \
            --tests "*ChaosTestSuite*stress*" \
            --continue || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-chaos-results
          path: |
            Android/src/app/build/test-results/
            Android/src/app/build/reports/tests/
          retention-days: 7

  # =============================================================================
  # Job 6: Generate Chaos Report
  # =============================================================================
  chaos-report:
    name: Generate Chaos Report
    runs-on: ubuntu-latest
    needs: [network-chaos, memory-chaos, battery-chaos, thermal-chaos, combined-chaos]
    if: always()
    
    steps:
      - name: Download All Test Results
        uses: actions/download-artifact@v4
        with:
          path: chaos-results
          pattern: '*-chaos-results'

      - name: Generate Report
        run: |
          cat > generate_chaos_report.py << 'EOF'
          import os
          import xml.etree.ElementTree as ET
          import json

          def parse_test_results(results_dir):
              results = {
                  'total_tests': 0,
                  'passed': 0,
                  'failed': 0,
                  'skipped': 0,
                  'suites': {}
              }
              
              for root, dirs, files in os.walk(results_dir):
                  for file in files:
                      if file.endswith('.xml'):
                          try:
                              tree = ET.parse(os.path.join(root, file))
                              root_elem = tree.getroot()
                              
                              for testsuite in root_elem.findall('.//testsuite'):
                                  suite_name = testsuite.get('name', 'Unknown')
                                  tests = int(testsuite.get('tests', 0))
                                  failures = int(testsuite.get('failures', 0))
                                  errors = int(testsuite.get('errors', 0))
                                  skipped = int(testsuite.get('skipped', 0))
                                  
                                  results['total_tests'] += tests
                                  results['failed'] += failures + errors
                                  results['skipped'] += skipped
                                  results['passed'] += tests - failures - errors - skipped
                                  
                                  results['suites'][suite_name] = {
                                      'tests': tests,
                                      'passed': tests - failures - errors - skipped,
                                      'failed': failures + errors,
                                      'skipped': skipped
                                  }
                          except Exception as e:
                              print(f"Error parsing {file}: {e}")
              
              return results

          def main():
              results = parse_test_results('chaos-results')
              
              # Calculate metrics
              if results['total_tests'] > 0:
                  results['pass_rate'] = (results['passed'] / results['total_tests']) * 100
                  results['failure_rate'] = (results['failed'] / results['total_tests']) * 100
              else:
                  results['pass_rate'] = 0
                  results['failure_rate'] = 0
              
              # Save report
              with open('chaos_report.json', 'w') as f:
                  json.dump(results, f, indent=2)
              
              # Print summary
              print("\n" + "="*60)
              print("ðŸ”¥ CHAOS ENGINEERING TEST REPORT")
              print("="*60)
              print(f"\nTotal Tests: {results['total_tests']}")
              print(f"âœ… Passed: {results['passed']}")
              print(f"âŒ Failed: {results['failed']}")
              print(f"â­ï¸ Skipped: {results['skipped']}")
              print(f"\nPass Rate: {results['pass_rate']:.1f}%")
              print(f"Failure Rate: {results['failure_rate']:.1f}%")
              
              # Resilience score
              resilience_score = results['pass_rate']
              print(f"\nðŸ›¡ï¸ Resilience Score: {resilience_score:.0f}/100")
              
              if resilience_score >= 90:
                  print("âœ… EXCELLENT: App shows strong resilience")
              elif resilience_score >= 75:
                  print("âš ï¸ GOOD: Minor resilience issues detected")
              elif resilience_score >= 50:
                  print("âš ï¸ MODERATE: Significant resilience improvements needed")
              else:
                  print("âŒ POOR: Critical resilience issues - immediate attention required")
              
              print("\n" + "="*60)
              
              # Exit with error if failure rate exceeds threshold
              if results['failure_rate'] > 10:
                  print("\nâŒ Failure rate exceeds 10% threshold")
                  exit(1)
              else:
                  print("\nâœ… Failure rate within acceptable threshold")
                  exit(0)

          if __name__ == '__main__':
              main()
          EOF
          
          python3 generate_chaos_report.py

      - name: Upload Chaos Report
        uses: actions/upload-artifact@v4
        with:
          name: chaos-report
          path: chaos_report.json
          retention-days: 30

      - name: Update Job Summary
        run: |
          if [ -f chaos_report.json ]; then
            echo "## ðŸ”¥ Chaos Engineering Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            TOTAL=$(cat chaos_report.json | grep -o '"total_tests": [0-9]*' | grep -o '[0-9]*')
            PASSED=$(cat chaos_report.json | grep -o '"passed": [0-9]*' | grep -o '[0-9]*')
            FAILED=$(cat chaos_report.json | grep -o '"failed": [0-9]*' | grep -o '[0-9]*')
            PASS_RATE=$(cat chaos_report.json | grep -o '"pass_rate": [0-9.]*' | grep -o '[0-9.]*')
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Pass Rate | ${PASS_RATE}% |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Test Categories" >> $GITHUB_STEP_SUMMARY
            echo "| Category | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Network Resilience | ${{ needs.network-chaos.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Memory Resilience | ${{ needs.memory-chaos.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Battery Resilience | ${{ needs.battery-chaos.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Thermal Resilience | ${{ needs.thermal-chaos.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Combined Stress | ${{ needs.combined-chaos.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
